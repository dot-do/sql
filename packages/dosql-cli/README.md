# dosql-cli

CLI tool for DoSQL - scaffold projects, run migrations, and generate TypeScript types.

## Installation

```bash
npm install -g dosql-cli
```

Or use directly with npx:

```bash
npx dosql-cli <command>
```

## Commands

### `dosql init`

Initialize a new DoSQL project with the standard directory structure.

```bash
dosql init [options]
```

**Options:**

| Option | Description | Default |
|--------|-------------|---------|
| `-d, --directory <path>` | Target directory for the project | Current working directory |
| `-n, --name <name>` | Project name | Directory name |
| `-f, --force` | Overwrite existing config file | `false` |

**Example:**

```bash
# Initialize in current directory
dosql init

# Initialize in a specific directory with a custom name
dosql init -d ./my-project -n my-database

# Overwrite existing config
dosql init --force
```

**Created Files:**

- `dosql.config.ts` - Project configuration
- `migrations/` - Directory for SQL migration files
- `schema/schema.ts` - Initial schema definition file

### `dosql migrate`

Find and run database migrations.

```bash
dosql migrate [options]
```

**Options:**

| Option | Description | Default |
|--------|-------------|---------|
| `-d, --directory <path>` | Migrations directory | `./migrations` |
| `-u, --url <url>` | DoSQL database URL | `DOSQL_URL` env var |
| `-t, --token <token>` | Authentication token | `DOSQL_TOKEN` env var |
| `--dry-run` | Show pending migrations without applying | `false` |
| `--timeout <ms>` | Connection timeout in milliseconds | `30000` |

**Example:**

```bash
# Run migrations with database URL
dosql migrate --url wss://your-database.example.com

# Using environment variables
export DOSQL_URL=wss://your-database.example.com
export DOSQL_TOKEN=your-auth-token
dosql migrate

# Preview pending migrations without applying
dosql migrate --dry-run

# Use a custom migrations directory
dosql migrate -d ./db/migrations
```

**Migration Naming Convention:**

Migrations are sorted and applied in lexicographical order. Use numeric prefixes to ensure correct ordering:

```
migrations/
  001_create_users_table.sql
  002_add_email_to_users.sql
  003_create_posts_table.sql
```

### `dosql generate`

Generate TypeScript interfaces from schema definitions.

```bash
dosql generate [options]
```

**Options:**

| Option | Description | Default |
|--------|-------------|---------|
| `-s, --schema <path>` | Schema directory | `./schema` |
| `-o, --output <path>` | Output directory | `./generated` |

**Example:**

```bash
# Generate types from default locations
dosql generate

# Use custom schema and output directories
dosql generate -s ./db/schema -o ./src/types
```

## Schema File Format

Schema files are TypeScript files that export table definitions. Each table definition must have:

- `tableName`: The SQL table name (string)
- `columns`: An object mapping column names to column definitions

**Column Definition Properties:**

| Property | Type | Description |
|----------|------|-------------|
| `type` | `'integer' \| 'text' \| 'real' \| 'blob' \| 'boolean'` | SQL column type |
| `primaryKey` | `boolean` | Whether this column is the primary key |
| `nullable` | `boolean` | Whether this column allows NULL values |

**Example Schema File:**

```typescript
// schema/users.ts

/**
 * User account information
 */
export const users = {
  tableName: 'users',
  columns: {
    /** Unique user identifier */
    id: { type: 'integer', primaryKey: true },
    /** User's email address */
    email: { type: 'text', nullable: false },
    /** Display name */
    name: { type: 'text', nullable: true },
    /** Account creation timestamp */
    created_at: { type: 'text', nullable: false },
  },
} as const;
```

**Generated Output:**

```typescript
// generated/types.ts
// This file is auto-generated by dosql generate
// Do not edit manually

/**
 * User account information
 */
export interface User {
  /** Unique user identifier */
  id: number;
  /** User's email address */
  email: string;
  /** Display name */
  name: string | null;
  /** Account creation timestamp */
  created_at: string;
}
```

## Programmatic API

The CLI can also be used programmatically in your Node.js applications.

### Creating a Custom CLI

```typescript
import { createCLI } from 'dosql-cli';

const cli = createCLI();
cli.parse(process.argv);
```

### Using Commands Directly

```typescript
import { initProject, generateTypes, findMigrations, runMigrations } from 'dosql-cli';

// Initialize a project
const initResult = await initProject({
  directory: './my-project',
  name: 'my-database',
  force: false,
});
console.log('Created files:', initResult.createdFiles);

// Generate types
const generateResult = await generateTypes({
  schemaDir: './schema',
  outputDir: './generated',
});
console.log('Tables processed:', generateResult.tablesProcessed);

// Find and run migrations
const migrations = await findMigrations('./migrations');
const migrateResult = await runMigrations({
  migrations,
  executor: async (sql, name) => {
    // Execute SQL against your database
    console.log(`Running migration: ${name}`);
    await myDatabase.exec(sql);
  },
  appliedMigrations: [], // List of already applied migration names
  dryRun: false,
});
console.log('Applied:', migrateResult.applied);
```

### Using Database Connection

```typescript
import { createMigrationConnection, runMigrationsWithConnection } from 'dosql-cli';

// Create a connection
const connection = await createMigrationConnection({
  url: 'wss://your-database.example.com',
  token: 'your-auth-token',
  timeout: 30000,
});

try {
  // Run migrations with the connection
  const result = await runMigrationsWithConnection({
    connection,
    migrationsDir: './migrations',
    dryRun: false,
  });
  console.log('Applied:', result.applied);
} finally {
  await connection.close();
}
```

## Exported Types

### Core Types

```typescript
// Init
interface InitOptions {
  directory: string;
  name?: string;
  force?: boolean;
}

interface InitResult {
  success: boolean;
  createdFiles: string[];
}

// Generate
interface GenerateOptions {
  schemaDir: string;
  outputDir: string;
}

interface GenerateResult {
  success: boolean;
  generatedFiles: string[];
  tablesProcessed: string[];
}

// Migrate
interface Migration {
  name: string;
  content: string;
  path: string;
}

interface MigrateOptions {
  migrations: Migration[];
  executor: (sql: string, name: string) => Promise<void>;
  appliedMigrations?: string[];
  dryRun?: boolean;
}

interface MigrateResult {
  applied: string[];
  pending: string[];
  error?: {
    migration: string;
    message: string;
  };
}
```

### Utility Exports

```typescript
// Path validation
import { validatePath, validateCliPath, PathValidationError } from 'dosql-cli';

// Error handling
import { toError, getErrorMessage } from 'dosql-cli';

// File utilities
import { fileExists, fileExistsSync } from 'dosql-cli';

// Logging
import { Logger, createLogger, logInfo, logError } from 'dosql-cli';
```

## Configuration

The `dosql.config.ts` file is generated by `dosql init` and configures your project:

```typescript
import { defineConfig } from 'dosql';

export default defineConfig({
  name: 'my-project',
  migrationsDir: './migrations',
  schemaDir: './schema',
  outputDir: './generated',
});
```

**Note:** The `defineConfig` function is provided by the `dosql` package, which is the runtime library for DoSQL applications.

## Environment Variables

| Variable | Description |
|----------|-------------|
| `DOSQL_URL` | Default database URL for migrations |
| `DOSQL_TOKEN` | Default authentication token |

## License

MIT
